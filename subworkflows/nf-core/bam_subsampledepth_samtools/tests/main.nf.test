nextflow_workflow {

    name "Test Subworkflow BAM_SUBSAMPLEDEPTH_SAMTOOLS"
    script "../main.nf"
    config "../nextflow.config"

    workflow "BAM_SUBSAMPLEDEPTH_SAMTOOLS"

    tag "subworkflows"
    tag "subworkflows_nfcore"
    tag "subworkflows/bam_subsampledepth_samtools"

    tag "samtools"
    tag "samtools/depth"
    tag "samtools/view"
    tag "gawk"

    test("Downsample to 4X and 2X") {
        when {
            workflow {
                """
                input[0] = channel.fromList([
                    [
                        [id: "NA12878"],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/phaseimpute/hum_data/individuals/NA12878/NA12878.s.bam", checkIfExist:true),
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/phaseimpute/hum_data/individuals/NA12878/NA12878.s.bam.bai", checkIfExist:true),
                    ],
                    [
                        [id: "NA19401"],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/phaseimpute/hum_data/individuals/NA19401/NA19401.s.bam", checkIfExist:true),
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/phaseimpute/hum_data/individuals/NA19401/NA19401.s.bam.bai", checkIfExist:true),
                    ],
                ])
                input[1] = channel.of([
                    [my_depth: "2x"], 2
                ],[
                    [my_depth: "4x"], 4
                ])
                input[2] = channel.of([
                    [id: "GRCh38"],
                    file("https://raw.githubusercontent.com/nf-core/test-datasets/phaseimpute/hum_data/reference_genome/GRCh38.s.fa.gz", checkIfExist:true),
                    file("https://raw.githubusercontent.com/nf-core/test-datasets/phaseimpute/hum_data/reference_genome/GRCh38.s.fa.gz.fai", checkIfExist:true)
                ]).collect()
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(
                workflow.out.bam_subsampled.collect{ meta, bam_file, bai_file -> [
                    meta, bam_file, bai_file,
                    bam(bam_file).getReads().size()
                ]}
            ).match()
        }
    }
}
