nextflow_workflow {

    name "Test Workflow VCF_PHASE_SHAPEIT5"
    config "./nextflow.config"
    script "../main.nf"
    workflow "VCF_PHASE_SHAPEIT5"

    tag "subworkflows"
    tag "subworkflows_nfcore"
    tag "subworkflows/vcf_phase_shapeit5"
    tag "vcf_phase_shapeit5"

    tag "glimpse2/chunk"
    tag "glimpse2"
    tag "shapeit5/phasecommon"
    tag "shapeit5/ligate"
    tag "shapeit5"
    tag "bcftools/index"
    tag "bcftools"

    tag "bcftools/view"
    tag "bcftools/pluginfilltags"

    test("homo_sapiens - target - no chunks, no ref, no scaffold, no map - one chromosome") {
        when {
            params {
                glimpse2_chunk_args = "--window-mb 0.1 --window-cm 0.1 --window-count 100 --buffer-mb 0.01 --buffer-cm 0.01 --buffer-count 10"
                bcftools_pluginfilltags_args = ""
                bcftools_pluginfilltags_args2 = ""
                bcftools_view_args = ""
            }
            workflow {
                """
                input[0] = Channel.of([
                    [id:'test', chr: "22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz.csi", checkIfExists:true),
                    [], // empty pedigree
                    "chr22:16570000-16610000" // Region to chunk
                ])
                input[1] = Channel.of([[id:'test', chr: "22"], []]) // Chunks
                input[2] = Channel.of([[id:'test', chr: "22"], [], []]) // Ref
                input[3] = Channel.of([[id:'test', chr: "22"], [], []]) // Scaffold
                input[4] = Channel.of([[id:'test', chr: "22"], []]) // Genetic map
                input[5] = true // Perform chunks
                input[6] = "recursive" // chunk_model
                """
            }
        }
        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcf_index.collect{[
                        it[0],
                        path(it[1]).getFileName().toString(),
                        path(it[2]).getFileName().toString(),
                        path(it[1]).vcf.summary,
                        path(it[1]).vcf.variantsMD5
                    ]},
                    workflow.out.chunks,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("homo_sapiens - target, ref, chunks - no scaffold - two chromosomes") {
        setup {
            run("BCFTOOLS_VIEW") {
                script "../../../../modules/nf-core/bcftools/view/main.nf"
                process {
                    """
                    input[0] = Channel.of(
                    [
                        [id:'NA12878', chr:"chr22"],
                        file(params.modules_testdata_base_path + "genomics/homo_sapiens/illumina/vcf/NA12878.chr21_22.1X.glimpse2.vcf.gz", checkIfExists: true),
                        file(params.modules_testdata_base_path + "genomics/homo_sapiens/illumina/vcf/NA12878.chr21_22.1X.glimpse2.vcf.gz.csi", checkIfExists: true),
                    ],[
                        [id:'NA12878', chr:"chr21"],
                        file(params.modules_testdata_base_path + "genomics/homo_sapiens/illumina/vcf/NA12878.chr21_22.1X.glimpse2.vcf.gz", checkIfExists: true),
                        file(params.modules_testdata_base_path + "genomics/homo_sapiens/illumina/vcf/NA12878.chr21_22.1X.glimpse2.vcf.gz.csi", checkIfExists: true)
                    ])
                    input[1] = []
                    input[2] = []
                    input[3] = []
                    """
                }
            }

            run("BCFTOOLS_PLUGINFILLTAGS") {
                script "../../../../modules/nf-core/bcftools/pluginfilltags/main.nf"
                process {
                    """
                    input[0] = BCFTOOLS_VIEW.out.vcf
                        .join(BCFTOOLS_VIEW.out.csi)
                    input[1] = []
                    input[2] = []
                    input[3] = []
                    """
                }
            }
        }
        when {
            params {
                glimpse2_chunk_args = ""
                bcftools_pluginfilltags_args = "--write-index"
                bcftools_pluginfilltags_args2 = "-t AC,AN"
                bcftools_view_args = "-Oz -e 'GT=\"./.\"||GT=\".\"' --write-index"
            }
            workflow {
                """
                input[0] = BCFTOOLS_PLUGINFILLTAGS.out.vcf
                    .join(BCFTOOLS_PLUGINFILLTAGS.out.csi)
                    .combine(Channel.of([[], []])) // No regions needed as chunks are provided
                input[1] = channel.of(
                    [[id:'NA12878', chr:"chr22"], "chr22:16570065-16597215"],
                    [[id:'NA12878', chr:"chr22"], "chr22:16587172-16609999"],
                    [[id:'NA12878', chr:"chr21"], "chr21:16570065-16597215"],
                    [[id:'NA12878', chr:"chr21"], "chr21:16587172-16609999"]
                )
                input[2] = channel.of(
                [
                    [id:'NA12878', chr:"chr22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz.csi", checkIfExists:true)
                ],[
                    [id:'NA12878', chr:"chr21"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr21.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr21.vcf.gz.csi", checkIfExists:true)
                ])
                input[3] = Channel.of(
                    [[id:'NA12878', chr:"chr22"], [], []],
                    [[id:'NA12878', chr:"chr21"], [], []]
                )
                input[4] = Channel.of(
                [
                    [id:'NA12878', chr:"chr22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/genome/genetic_map/genome.GRCh38.chr22.glimpse.map", checkIfExists:true)
                ],[
                    [id:'NA12878', chr:"chr21"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/genome/genetic_map/genome.GRCh38.chr21.glimpse.map", checkIfExists:true)
                ])
                input[5] = false // Perform chunks
                input[6] = "recursive" // chunk_model
                """
            }
        }
        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out.vcf_index.collect{[
                        it[0],
                        path(it[1]).getFileName().toString(),
                        path(it[2]).getFileName().toString(),
                        path(it[1]).vcf.summary,
                        path(it[1]).vcf.header.getGenotypeSamples().sort(),
                        path(it[1]).vcf.variantsMD5
                    ]},
                    workflow.out.chunks,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("homo_sapiens - target - no error -- stub") {
        options "-stub"
        when {
            params {
                glimpse2_chunk_args = ""
                bcftools_pluginfilltags_args = "--write-index"
                bcftools_pluginfilltags_args2 = "-t AC,AN"
                bcftools_view_args = ""
            }
            workflow {
                """
                input[0] = Channel.of([
                    [id:'test', chr: "22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz.csi", checkIfExists:true),
                    [],
                    "chr22:16570065-16609999"
                ])
                input[1] = Channel.of([[id:'test', chr: "22"], []]) // Chunks
                input[2] = Channel.of([[id:'test', chr: "22"], [], []]) // Ref
                input[3] = Channel.of([[id:'test', chr: "22"], [], []]) // Scaffold
                input[4] = Channel.of([[id:'test', chr: "22"], []]) // Genetic map
                input[5] = true // Perform chunks
                input[6] = "recursive" // chunk_model
                """
            }
        }
        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                    workflow.out,
                    workflow.out.versions
                ).match() }
            )
        }
    }

    test("homo_sapiens - target - error: empty channel -- stub") {
        options "-stub"
        when {
            params {
                glimpse2_chunk_args = ""
                bcftools_pluginfilltags_args = "--write-index"
                bcftools_pluginfilltags_args2 = "-t AC,AN"
                bcftools_view_args = ""
            }
            workflow {
                """
                input[0] = Channel.of([
                    [id:'test', chr: "22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz.csi", checkIfExists:true),
                    [],
                    "chr22:16570065-16609999"
                ])
                input[1] = Channel.of([[id:'test', chr: "22"], []]) // Chunks
                input[2] = Channel.of([[id:'test', chr: "21"], [], []]) // Ref wrong chr result in empty channel
                input[3] = Channel.of([[id:'test', chr: "22"], [], []]) // Scaffold
                input[4] = Channel.of([[id:'test', chr: "22"], []]) // Genetic map
                input[5] = true // Perform chunks
                input[6] = "recursive" // chunk_model
                """
            }
        }
        then {
            assertAll(
                { assert workflow.failed },
                { assert workflow.errorMessage.contains("ERROR: join operation resulted in an empty channel.") }
            )
        }
    }

    test("homo_sapiens - target - error: chunks provided and chunk is true -- stub") {
        options "-stub"
        when {
            params {
                glimpse2_chunk_args = ""
                bcftools_pluginfilltags_args = "--write-index"
                bcftools_pluginfilltags_args2 = "-t AC,AN"
                bcftools_view_args = ""
            }
            workflow {
                """
                input[0] = Channel.of([
                    [id:'test', chr: "22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz.csi", checkIfExists:true),
                    [],
                    "chr22:16570065-16609999"
                ])
                input[1] = Channel.of([[id:'test', chr: "22"], "chr22:16570065-16597215"]) // Chunks provided
                input[2] = Channel.of([[id:'test', chr: "22"], [], []]) // Ref
                input[3] = Channel.of([[id:'test', chr: "22"], [], []]) // Scaffold
                input[4] = Channel.of([[id:'test', chr: "22"], []]) // Genetic map
                input[5] = true // Perform chunks
                input[6] = "recursive" // chunk_model
                """
            }
        }
        then {
            assertAll(
                { assert workflow.failed },
                { assert workflow.errorMessage.contains("ERROR: Cannot provide pre-defined chunks (regionin) when chunk=true.") }
            )
        }
    }

    test("homo_sapiens - target - error: chunks not provided and chunk is false -- stub") {
        options "-stub"
        when {
            params {
                glimpse2_chunk_args = ""
                bcftools_pluginfilltags_args = "--write-index"
                bcftools_pluginfilltags_args2 = "-t AC,AN"
                bcftools_view_args = ""
            }
            workflow {
                """
                input[0] = Channel.of([
                    [id:'test', chr: "22"],
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz", checkIfExists:true),
                    file(params.modules_testdata_base_path + "genomics/homo_sapiens/popgen/1000GP.chr22.vcf.gz.csi", checkIfExists:true),
                    [],
                    "chr22:16570065-16609999"
                ])
                input[1] = Channel.of([[id:'test', chr: "22"], []]) // Chunks provided
                input[2] = Channel.of([[id:'test', chr: "22"], [], []]) // Ref
                input[3] = Channel.of([[id:'test', chr: "22"], [], []]) // Scaffold
                input[4] = Channel.of([[id:'test', chr: "22"], []]) // Genetic map
                input[5] = false // Perform chunks
                input[6] = "recursive" // chunk_model
                """
            }
        }
        then {
            assertAll(
                { assert workflow.failed },
                { assert workflow.errorMessage.contains("ERROR: ch_chunks channel is empty. Please provide a valid channel or set chunk parameter to true.") }
            )
        }
    }
}
