nextflow_workflow {

    name "Test Subworkflow FASTQ_SHORTREADS_PREPROCESS_QC"
    script "../main.nf"
    workflow "FASTQ_SHORTREADS_PREPROCESS_QC"
    config './nextflow.config'

    tag "subworkflows"
    tag "subworkflows_nfcore"
    tag "subworkflows/fastq_shortreads_preprocess_qc"
    tag "subworkflows/fastq_qc_stats"
    tag "fastqc"
    tag "seqfu"
    tag "seqfu/check"
    tag "seqfu/stats"
    tag "seqkit"
    tag "seqkit/stats"
    tag "seqtk"
    tag "seqtk/comp"
    tag "subworkflows/fastq_preprocess_seqkit"
    tag "subworkflows/fastq_sanitise_seqkit"
    tag "seqkit"
    tag "seqkit/sana"
    tag "seqkit/pair"
    tag "seqkit/seq"
    tag "seqkit/replace"
    tag "seqkit/rmdup"
    tag "umitools"
    tag "umitools/extract"
    tag "prinseqplusplus"
    tag "bbmap"
    tag "bbmap/clumpify"
    tag "subworkflows/fastq_decontaminate_deacon_hostile"
    tag "subworkflows/fastq_index_filter_deacon"
    tag "subworkflows/fastq_fetch_clean_hostile"
    tag "hostile"
    tag "hostile/fetch"
    tag "hostile/clean"
    tag "bowtie2/build"
    tag "deacon"
    tag "deacon/filter"
    tag "deacon/index"
    tag "cat"
    tag "cat/fastq"

    test("sarscov2 - fastq - seqfu - seqkit - deacon - single_end") {

        when {
            workflow {
                """
                input[0] = channel.of([
                    [ id:'test', single_end:true ],
                    file(params.modules_testdata_base_path + 'genomics/sarscov2/illumina/fastq/test_1.fastq.gz', checkIfExists: true)
                ])
                input[1]  = true     // skip_fastqc
                input[2]  = false    // skip_seqfu_check
                input[3]  = false    // skip_seqfu_stats
                input[4]  = true     // skip_seqkit_stats
                input[5]  = true     // skip_seqtk_comp
                input[6]  = false    // skip_seqkit_sana_pair
                input[7]  = false    // skip_seqkit_seq
                input[8]  = false    // skip_seqkit_replace
                input[9]  = false    // skip_seqkit_rmdup
                input[10] = true     // skip_umitools_extract
                input[11] = 0        // umi_discard_read

                input[12] = true     // skip_prinseqplusplus
                input[13] = true     // skip_bbmap_clumpify
                input[14] = false    // skip_decontamination
                input[15] = channel.of(
                    [
                        [ id:'test', single_end:true ],
                        file(params.modules_testdata_base_path + 'genomics/sarscov2/genome/genome.fasta', checkIfExists: true)
                    ]
                )                    // ch_fasta
                input[16] = []       // ch_reference
                input[17] = []       // index_name
                input[18] = 'deacon' // decontaminator
                input[19] = true     // skip_cat_fastq
                """
            }
        }
        then {
            assert workflow.success
            assertAll(
                { assert snapshot(
                    workflow.out.reads[0][1],
                    workflow.out.pre_stats_seqfu_check,
                    workflow.out.pre_stats_seqfu_stats,
                    workflow.out.post_stats_seqfu_check,
                    workflow.out.post_stats_seqfu_stats,
                    workflow.out.deacon_index,
                    file(workflow.out.deacon_summary[0][1]).name,
                    workflow.out.multiqc_files,
                    workflow.out.versions.collect { path(it).yaml }
                ).match() }
            )
        }
    }

    test("sarscov2 - fastq - skip all - single_end") {

        when {
            workflow {
                """
                input[0] = channel.of([
                    [ id:'test', single_end:true ],
                    file(params.modules_testdata_base_path + 'genomics/sarscov2/illumina/fastq/test_1.fastq.gz', checkIfExists: true)
                ])
                input[1]  = true // skip_fastqc
                input[2]  = true // skip_seqfu_check
                input[3]  = true // skip_seqfu_stats
                input[4]  = true // skip_seqkit_stats
                input[5]  = true // skip_seqtk_comp
                input[6]  = true // skip_seqkit_sana_pair
                input[7]  = true // skip_seqkit_seq
                input[8]  = true // skip_seqkit_replace
                input[9]  = true // skip_seqkit_rmdup
                input[10] = true // skip_umitools_extract
                input[11] = 0    // umi_discard_read

                input[12] = true // skip_prinseqplusplus
                input[13] = true // skip_bbmap_clumpify
                input[14] = true // skip_decontamination
                input[15] = []   // ch_fasta
                input[16] = []   // ch_reference
                input[17] = []   // index_name
                input[18] = ""   // decontaminator
                input[19] = true // skip_cat_fastq
                """
            }
        }
        then {
            assert workflow.success
            assertAll(
                { assert snapshot(
                    workflow.out.reads[0][1],
                    workflow.out.versions.collect { path(it).yaml }
                ).match() }
            )
        }
    }

    test("sarscov2 - fastq - skip all - single_end - stub") {

        options "-stub"

        when {
            workflow {
                """
                input[0] = channel.of([
                    [ id:'test', single_end:true ],
                    file(params.modules_testdata_base_path + 'genomics/sarscov2/illumina/fastq/test_1.fastq.gz', checkIfExists: true)
                ])
                input[1]  = true // skip_fastqc
                input[2]  = true // skip_seqfu_check
                input[3]  = true // skip_seqfu_stats
                input[4]  = true // skip_seqkit_stats
                input[5]  = true // skip_seqtk_comp
                input[6]  = true // skip_seqkit_sana_pair
                input[7]  = true // skip_seqkit_seq
                input[8]  = true // skip_seqkit_replace
                input[9]  = true // skip_seqkit_rmdup
                input[10] = true // skip_umitools_extract
                input[11] = 0    // umi_discard_read

                input[12] = true // skip_prinseqplusplus
                input[13] = true // skip_bbmap_clumpify
                input[14] = true // skip_decontamination
                input[15] = []   // ch_fasta
                input[16] = []   // ch_reference
                input[17] = []   // index_name
                input[18] = ""   // decontaminator
                input[19] = true // skip_cat_fastq
                """
            }
        }
        then {
            assert workflow.success
            assertAll(
                { assert snapshot(workflow.out.reads).match() }
            )
        }
    }
}
