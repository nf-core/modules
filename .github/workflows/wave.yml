name: Wave
# When environment.yml is changed
on:
  pull_request:
    paths:
      - "**/environment.yml"
      - "**/Dockerfile"

# TODO On complete call testing CI
# TODO Skip testing CI if any changes to environment.yml

env:
  # renovate: datasource=github-releases depName=seqeralabs/wave-cli versioning=semver
  WAVE_VERSION: "1.5.0"
  # renovate: datasource=github-releases depName=askimed/nf-test versioning=semver
  NFT_VER: "0.9.3"
  # renovate: datasource=github-releases depName=nextflow/nextflow versioning=semver
  NXF_VER: "25.04.8"

jobs:
  generate-matrix:
    name: generate-matrix
    runs-on: ubuntu-latest
    # Only run on Pull Requests within the same repository, and not from forks
    if: github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      conda-matrix: ${{ steps.conda-diff.outputs.all_changed_files }}
      dockerfile-matrix: ${{ steps.docker-diff.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Find conda differences
        id: conda-diff
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          json: true
          escape_json: false
          files: |
            modules/**/environment.yml

      - name: Find Dockerfile differences
        id: docker-diff
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          json: true
          escape_json: false
          files: |
            modules/**/Dockerfile

  conda-wave:
    # NOTE This should get skipped because generate-matrix won't run
    # if: github.repository == 'nf-core/modules'
    if: ${{ needs.generate-matrix.outputs.conda-matrix != '[]' }}
    needs: generate-matrix
    name: Build ${{ matrix.profile }} ${{ matrix.platform }} Container
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        files: "${{ fromJson(needs.generate-matrix.outputs.conda-matrix) }}"
        profile: [docker, singularity]
        platform: ["linux/amd64", "linux/arm64"]
    outputs:
      container_info: ${{ steps.build_container.outputs.container_output }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Install wave-cli
        run: |
          wget -q https://github.com/seqeralabs/wave-cli/releases/download/v${WAVE_VERSION}/wave-${WAVE_VERSION}-linux-x86_64
          sudo mv wave-${WAVE_VERSION}-linux-x86_64 /usr/local/bin/wave
          chmod +x /usr/local/bin/wave

      - name: Build ${{ matrix.profile }} container
        id: build_container
        # FIXME Hack while iron out the CI
        continue-on-error: true
        env:
          PROFILE: ${{ (contains(matrix.profile, 'singularity') && '--singularity') || '' }}
        run: |
          output=$(wave --conda-file "${{ matrix.files }}" \
              $PROFILE \
              --freeze \
              --await \
              --platform ${{ matrix.platform }} \
              --tower-token ${{ secrets.TOWER_ACCESS_TOKEN }} \
              --tower-workspace-id ${{ secrets.TOWER_WORKSPACE_ID }})
          echo "container_output=$output" >> $GITHUB_OUTPUT

  dockerfile-wave:
    # NOTE This should get skipped because generate-matrix won't run
    # if: github.repository == 'nf-core/modules'
    if: ${{ needs.generate-matrix.outputs.dockerfile-matrix != '[]' }}
    needs: generate-matrix
    name: Build Dockerfile-based ${{ matrix.platform }} Container
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        files: "${{ fromJson(needs.generate-matrix.outputs.dockerfile-matrix) }}"
        # NOTE singularity build requires a Singularity definition file in place of Dockerfile
        # https://nextflow.slack.com/archives/C0477AS31T5/p1731755350230149?thread_ts=1731697852.661849&cid=C0477AS31T5
        # profile: [docker]
        platform: ["linux/amd64", "linux/arm64"]
    outputs:
      container_info: ${{ steps.build_container.outputs.container_output }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Install wave-cli
        run: |
          wget -q https://github.com/seqeralabs/wave-cli/releases/download/v${WAVE_VERSION}/wave-${WAVE_VERSION}-linux-x86_64
          sudo mv wave-${WAVE_VERSION}-linux-x86_64 /usr/local/bin/wave
          chmod +x /usr/local/bin/wave

      - name: Create a registry name
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        id: registry-name
        with:
          result-encoding: string
          script: |
            return '${{ matrix.files }}'.replace('modules/nf-core/', '').replace('/Dockerfile', '').replace('/', '_');

      - name: Build ${{ matrix.platform }} container
        id: build_container
        # NOTE If you're changing a Dockerfile and this is running, try to update the Dockerfile to build with wave
        continue-on-error: false
        run: |
          output=$(wave -f "${{ matrix.files }}" \
              --freeze \
              --await \
              --platform ${{ matrix.platform }} \
              --build-repo quay.io/nf-core/modules/${{steps.registry-name.outputs.result}} \
              --cache-repository quay.io/nf-core/wave-cache/docker/${{ matrix.platform }} \
              --tower-token ${{ secrets.TOWER_ACCESS_TOKEN }} \
              --tower-workspace-id ${{ secrets.TOWER_WORKSPACE_ID }})
          echo "container_output=$output" >> $GITHUB_OUTPUT

  update-meta-yml:
    needs: [generate-matrix, conda-wave, dockerfile-wave]
    # Make sure this job runs even if some dependencies fail
    if: always() && (needs.generate-matrix.outputs.conda-matrix != '[]' || needs.generate-matrix.outputs.dockerfile-matrix != '[]')
    name: Update meta.yml with Container Info
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug workflow state
        run: |
          echo "Conda Matrix: ${{ needs.generate-matrix.outputs.conda-matrix }}"
          echo "Dockerfile Matrix: ${{ needs.generate-matrix.outputs.dockerfile-matrix }}"
          echo "Conda Wave Result: ${{ needs.conda-wave.result }}"
          echo "Conda Wave Output: ${{ needs.conda-wave.outputs.container_info }}"
          echo "Dockerfile Wave Result: ${{ needs.dockerfile-wave.result }}"
          echo "Dockerfile Wave Output: ${{ needs.dockerfile-wave.outputs.container_info }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Update meta.yml files
        run: |
          # Process whatever outputs are available, ignoring failures
          CONDA_FILES='${{ needs.generate-matrix.outputs.conda-matrix }}'
          DOCKERFILE_FILES='${{ needs.generate-matrix.outputs.dockerfile-matrix }}'
          CONDA_CONTAINERS='[]'
          DOCKERFILE_CONTAINERS='[]'

          # Use actual outputs if they exist
          if [[ "${{ needs.conda-wave.result || 'skipped' }}" == "success" ]]; then
            CONDA_CONTAINERS='${{ needs.conda-wave.outputs.container_info || '[]' }}'
          fi

          if [[ "${{ needs.dockerfile-wave.result || 'skipped' }}" == "success" ]]; then
            DOCKERFILE_CONTAINERS='${{ needs.dockerfile-wave.outputs.container_info || '[]' }}'
          fi

          echo "Running update script with:"
          echo "Conda files: $CONDA_FILES"
          echo "Dockerfile files: $DOCKERFILE_FILES"
          echo "Conda containers: $CONDA_CONTAINERS"
          echo "Dockerfile containers: $DOCKERFILE_CONTAINERS"

          python .github/scripts/update_meta_yml.py \
            --conda-files "$CONDA_FILES" \
            --dockerfile-files "$DOCKERFILE_FILES" \
            --conda-containers "$CONDA_CONTAINERS" \
            --dockerfile-containers "$DOCKERFILE_CONTAINERS"

      - name: Commit changes
        run: |
          git config user.email "infrastructure@nf-co.re"
          git config user.name "nf-core-bot"
          git add "**/meta.yml"
          git diff --staged --quiet || git commit -m "[automated] Update container info in meta.yml [skip ci]"
          git push
