name: "nf-test Action"
description: "Runs nf-test with common setup steps"
inputs:
  profile:
    description: "Profile to use"
    required: true
  shard:
    description: "Shard number for this CI job"
    required: true
  total_shards:
    description: "Total number of test shards(NOT the total number of matrix jobs)"
    required: true
  paths:
    description: "Test paths"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Set up Nextflow
      uses: nf-core/setup-nextflow@v2
      with:
        version: "${{ env.NXF_VERSION }}"

    - name: Set up Python
      uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5
      with:
        python-version: "3.11"

    - name: Set up nf-test
      uses: nf-core/setup-nf-test@v1
      with:
        version: "${{ env.NFT_VER }}"
        install-pdiff: true

    - name: Install dependencies from universe repo
      if: contains(inputs.profile, 'singularity')
      shell: bash
      run: |
        sudo add-apt-repository universe
        sudo apt-get update
        sudo apt-get install -y uidmap squashfs-tools

    - name: Setup apptainer
      if: contains(inputs.profile, 'singularity')
      uses: eWaterCycle/setup-apptainer@3f706d898c9db585b1d741b4692e66755f3a1b40 #v2

    - name: Set up Singularity
      if: contains(inputs.profile, 'singularity')
      shell: bash
      run: |
        mkdir -p $NXF_SINGULARITY_CACHEDIR
        mkdir -p $NXF_SINGULARITY_LIBRARYDIR

    - name: Set up Conda
      if: ${{inputs.profile == 'conda'}}
      uses: conda-incubator/setup-miniconda@505e6394dae86d6a5c7fbb6e3fb8938e3e863830 # v3
      with:
        auto-update-conda: true
        conda-solver: libmamba
        conda-remove-defaults: true

    # Set up secrets
    - name: Set up Nextflow secrets
      if: env.SENTIEON_ENCRYPTION_KEY != '' && env.SENTIEON_LICENSE_MESSAGE != ''
      shell: bash
      run: |
        python -m pip install cryptography
        nextflow secrets set SENTIEON_AUTH_DATA $(python3 tests/modules/nf-core/sentieon/license_message.py encrypt --key "$SENTIEON_ENCRYPTION_KEY" --message "$SENTIEON_LICENSE_MESSAGE")

      # TODO Skip failing conda tests and document their failures
      # https://github.com/nf-core/modules/issues/7017
    - name: Run nf-test
      shell: bash
      env:
        SENTIEON_LICSRVR_IP: ${{ env.SENTIEON_LICSRVR_IP }}
        SENTIEON_AUTH_MECH: "GitHub Actions - token"
      run: |
        NFT_WORKDIR=~ \
        NFT_DIFF=pdiff \
        NFT_DIFF_ARGS="--line-numbers --expand-tabs=2"

        nf-test test \
          --profile=${{ inputs.profile }} \
          --junitxml nf-test-${{ inputs.profile }}-${{ inputs.shard }}-${{ inputs.total_shards }}-junit.xml
          --verbose \
          --ci \
          --shard ${{ inputs.shard }}/${{ inputs.total_shards }} \
          --filter process,workflow \
          ${{ inputs.paths }}

    - uses: actions/upload-artifact@v4 # upload test results
      if: success() || failure() # run this step even if previous step failed
      with:
        name: test-results-${{ inputs.profile }}-${{ inputs.shard }}-${{ inputs.total_shards }}
        path: nf-test-${{ inputs.profile }}-${{ inputs.shard }}-${{ inputs.total_shards }}-junit.xml

    - name: Clean up
      if: always()
      shell: bash
      run: |
        sudo rm -rf /home/ubuntu/tests/
